name: Nginx CI/CD (ASG)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
    paths:
      - "nginx/**"
      - ".github/workflows/nginx-ecr-asg.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "nginx/**"
      - ".github/workflows/nginx-ecr-asg.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  nginx-build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. CI: Nginx Config Check
      - name: Nginx Config Check
        run: |
          docker run --rm --add-host=backend:127.0.0.1 -v "${{ github.workspace }}/nginx":/etc/nginx/conf.d:ro nginx:latest nginx -t

      # 2. Configure AWS Credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws-region: "${{ vars.AWS_REGION }}"

      # 3. Login to Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Docker Metadata for tagging
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY_NGINX }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
            type=ref,event=tag
            type=sha,format=short

      # 5. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. Build and Push to ECR
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./nginx
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 7. Deploy to ASG via Launch Template Update
      - name: Deploy to ASG
        if: github.event_name != 'pull_request'
        run: |
          # 1. Get Launch Template ID from Tags
          LT_ID=$(aws ec2 describe-launch-templates --filters "Name=tag:${{ vars.ASG_TAG_KEY }},Values=${{ vars.ASG_TAG_VALUE }}" --query 'LaunchTemplates[0].LaunchTemplateId' --output text)
          
          if [ "$LT_ID" == "None" ] || [ -z "$LT_ID" ]; then
            echo "Error: Launch Template not found with tags ${{ vars.ASG_TAG_KEY }}=${{ vars.ASG_TAG_VALUE }}"
            exit 1
          fi
          echo "Found Launch Template ID: $LT_ID"

          # 2. Create new Launch Template Version
          # Just creating a new version from Latest to ensure we have a unique deployment event.
          NEW_VER=$(aws ec2 create-launch-template-version --launch-template-id $LT_ID --source-version '$Latest' --version-description "Deploy ${{ github.sha }}" --query 'LaunchTemplateVersion.VersionNumber' --output text)
          echo "Created Launch Template Version: $NEW_VER"

          # 3. Find ASG using this Launch Template
          ASG_NAME=$(aws autoscaling describe-auto-scaling-groups --query "AutoScalingGroups[?LaunchTemplate.LaunchTemplateId=='$LT_ID'].AutoScalingGroupName" --output text)
            
          if [ "$ASG_NAME" == "None" ] || [ -z "$ASG_NAME" ]; then
            echo "Error: No Auto Scaling Group found using Launch Template ID $LT_ID"
            exit 1
          fi
          echo "Found Auto Scaling Group: $ASG_NAME"

          # 4. Update ASG to use the new Launch Template Version
          aws autoscaling update-auto-scaling-group --auto-scaling-group-name $ASG_NAME --launch-template "LaunchTemplateId=$LT_ID,Version=$NEW_VER"

          # 5. Trigger Instance Refresh
          aws autoscaling start-instance-refresh --auto-scaling-group-name $ASG_NAME --preferences '{"MinHealthyPercentage": 50, "InstanceWarmup": 300}'
          
          echo "Deployment initiated. Instance Refresh started for $ASG_NAME."