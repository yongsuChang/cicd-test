name: Build and Push to ECR

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws-region: "${{vars.AWS_REGION}}"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Nginx
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/${{ vars.ECR_REPOSITORY_NGINX }}:${IMAGE_TAG} ./nginx
          docker push $ECR_REGISTRY/${{ vars.ECR_REPOSITORY_NGINX }}:${IMAGE_TAG}

      # ==========================================================
      # 핵심 추가 단계: k8s 폴더의 YAML 파일을 수정하여 ArgoCD에게 배포를 지시합니다.
      # ==========================================================
      - name: Update K8s Manifests (ArgoCD Trigger)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # k8s 폴더 내의 모든 .yaml과 .yml 파일을 찾아서 이미지 업데이트
          # 'stand-alone-nginx' 문자열이 포함된 이미지 라인을 찾아서 확실하게 교체합니다.
          find k8s -name "*.y*ml" -exec sed -i "s|image: .*stand-alone-nginx.*|image: $ECR_REGISTRY/${{ vars.ECR_REPOSITORY_NGINX }}:$IMAGE_TAG|g" {} +

          # 변경된 사항이 있을 때만 Git 작업을 진행합니다.
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'

          # 변경된 yaml 파일들만 스테이징
          git add k8s/*.y*ml || echo "No files to add"

          # 변경 사항이 있는지 확인 후 커밋 (변경 사항 없으면 건너뜀)
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # [skip ci]를 넣어 자동화 커밋이 다시 Action을 실행시키지 않게 합니다.
            git commit -m "Auto-deploy: update image tags [skip ci]"

            # 다른 작업과 충돌 방지를 위해 pull 후 push 합니다.
            git pull --rebase origin main
            git push origin main
          fi

